document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("modal");
  const successModal = document.getElementById("successModal");
  const calendarEl = document.getElementById("calendar") || document.getElementById("events-calendar");
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: "dayGridMonth",
    locale: "uk",
    events: [],
    height: "auto",
    headerToolbar: {
      left: "prev,next today",
      center: "title",
      right: "dayGridMonth,timeGridWeek"
    }
  });
  calendar.render();

  const events = [];

  // Відкрити модальне вікно
  const openModalBtn = document.getElementById("openModalBtn") || document.getElementById("btn-create");
  if (openModalBtn) {
    openModalBtn.addEventListener("click", () => {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    });
  }

  // Зберегти подію
  document.getElementById("saveBtn").addEventListener("click", () => {
    const title = document.getElementById("titleInput").value.trim();
    const desc = document.getElementById("descInput").value.trim();
    const date = document.getElementById("dateInput").value;
    const time = document.getElementById("timeInput").value;
    const status = document.getElementById("statusInput").value;

    if (!title || !date || !time) {
      alert("Будь ласка, заповніть всі обовʼязкові поля.");
      return;
    }

    const event = { title, desc, date, time, status };
    events.push(event);
    addToTable(event);
    calendar.addEvent({ title, start: `${date}T${time}` });

    modal.classList.add("hidden");
    modal.classList.remove("flex");
    showSuccess();
    clearForm();
  });

  // Перемикання вкладок
  const tabTable = document.getElementById("tabTable") || document.getElementById("btn-table");
  const tabCalendar = document.getElementById("tabCalendar") || document.getElementById("btn-calendar");

  if (tabTable) {
    tabTable.addEventListener("click", () => {
      document.getElementById("tableView").classList.remove("hidden");
      document.getElementById("calendarView").classList.add("hidden");
      setActiveTab(tabTable.id);
    });
  }

  if (tabCalendar) {
    tabCalendar.addEventListener("click", () => {
      document.getElementById("calendarView").classList.remove("hidden");
      document.getElementById("tableView").classList.add("hidden");
      setActiveTab(tabCalendar.id);
    });
  }

  // Пошук
  const searchInput = document.querySelector("input[placeholder='Пошук...']");
  if (searchInput) {
    searchInput.addEventListener("input", (e) => {
      const query = e.target.value.toLowerCase();
      const rows = document.querySelectorAll("#eventTableBody tr");
      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(query) ? "" : "none";
      });
    });
  }

  // Мова календаря
  const langSelect = document.getElementById("languageSelect");
  if (langSelect) {
    langSelect.addEventListener("change", (e) => {
      const lang = e.target.value;
      calendar.setOption("locale", lang);
    });
  }

  // Telegram заглушка
  const telegramBtn = document.getElementById("btn-telegram");
  if (telegramBtn) {
    telegramBtn.addEventListener("click", () => {
      alert("Імпорт із Telegram не реалізовано");
    });
  }

  function addToTable(event) {
    const tbody = document.getElementById("eventTableBody");
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="p-2">${events.length}</td>
      <td class="p-2">${event.title}</td>
      <td class="p-2">${event.desc}</td>
      <td class="p-2">${event.date}</td>
      <td class="p-2">${event.time}</td>
      <td class="p-2">${event.status}</td>
    `;
    tbody.appendChild(row);
  }

  function clearForm() {
    document.getElementById("titleInput").value = "";
    document.getElementById("descInput").value = "";
    document.getElementById("dateInput").value = "";
    document.getElementById("timeInput").value = "";
    document.getElementById("statusInput").value = "Активна";
  }

  function showSuccess() {
    successModal.classList.remove("hidden");
    successModal.classList.add("flex");
    setTimeout(() => {
      successModal.classList.add("hidden");
      successModal.classList.remove("flex");
    }, 2000);
  }

  function setActiveTab(id) {
    document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active-tab"));
    const active = document.getElementById(id);
    if (active) active.classList.add("active-tab");
  }
});

